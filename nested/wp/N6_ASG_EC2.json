{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Creation of Auto Scaling Group associated with a Scaling Policy Request Count Target Value",
    "Parameters": {
        "VPC": {
            "Type": "String"
        },
        "SubnetPubA": {
            "Type": "String"
        },
        "SubnetPubB": {
            "Type": "String"
        },
        "SubnetPubC": {
            "Type": "String"
        },
        "LaunchTemplateId": {
            "Type": "String"
        },
        "LaunchTemplateVersion": {
            "Type": "String"
        },
        "TargetGroupLoadBalancerARN": {
            "Type": "String"
        },
        "ALBRequestCountTargetValue": {
            "Type": "String"
        },
        "LoadBalancerFullName": {
            "Type": "String"
        },
        "TargetGroupFullName": {
            "Type": "String"
        }
    },
    "Resources": {
        "myASG": {
            "Type": "AWS::AutoScaling::AutoScalingGroup",
            "Properties": {
                "LaunchTemplate": {
                    "LaunchTemplateId": { "Ref": "LaunchTemplateId" },
                    "Version": { "Ref": "LaunchTemplateVersion" }
                },
                "TargetGroupARNs": [{ "Ref": "TargetGroupLoadBalancerARN" }],
                "VPCZoneIdentifier": [
                    { "Ref": "SubnetPubA" },
                    { "Ref": "SubnetPubB" },
                    { "Ref": "SubnetPubC" }
                ],
                "HealthCheckType": "ELB",
                "DesiredCapacity": "1",
                "MinSize": "1",
                "MaxSize": "3",
                "Tags": [
                    {
                        "Key": "Name",
                        "PropagateAtLaunch": true,
                        "Value": "Wordpress-ASG"
                    }
                ]
            }
        },
        "myALBRequestCountPolicy": {
            "Type": "AWS::AutoScaling::ScalingPolicy",
            "Properties": {
                "AutoScalingGroupName": {
                    "Ref": "myASG"
                },
                "PolicyType": "TargetTrackingScaling",
                "TargetTrackingConfiguration": {
                    "PredefinedMetricSpecification": {
                        "PredefinedMetricType": "ALBRequestCountPerTarget",
                        "ResourceLabel": {
                            "Fn::Join": [
                                "/",
                                [
                                    { "Ref": "LoadBalancerFullName" },
                                    { "Ref": "TargetGroupFullName" }
                                ]
                            ]
                        }
                    },
                    "TargetValue": {
                        "Ref": "ALBRequestCountTargetValue"
                    }
                }
            }
        }
    }
}
